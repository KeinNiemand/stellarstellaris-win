# Hull / Armor / Shield regen overflow

On ships with excessive HP and high regen percentage for Hull, armor, or shields, the regen rate calculation can overflow, causing negative regen.

This calculation occurs in CShip::CalcRegenData and has something to do with the CFixedPoint abstraction that is used to store these values.

Most of the Fixed point implementation is optimized out by the compiler, so from the remaining assembly it is unclear why these are stored in fixed points rather than just a more normal uint64_t or double. I believe the issue is caused by the way the fixed point implementation is abstracted / optimized out, as in the assembly there is a ```imul %r8, %rdx``` and 2 or 3 operand imul truncates the result (64 bit * 64 bit = 64 bit).

Weirdly, the assembly of the implementation seems to overwrite part of the multiplication with a const, in order to /100000. (apparently, multiplying by a const and then bit shifting both registers is a compiler optimization for division)

Compiler explorer demo used for research:
https://compiler-explorer.com/#z:OYLghAFBqd5QCxAFwE4FN0BoCWIIDGAtgIYDW6AgqsAM4gDkAtACIDCAspQNICiA%2BgCEAqgEkAMi34AVAJoAFXgFIAzCxboARgFdgDLAQD2RAA44ANulTiSAO2DaSwdKIAmIAkoBMg74IPatMjGAPLayCbhAGIW6LYkROgoCOj86AAe6AThJJqWWABmsfSw6K44wahuIACMhbHVXl71lvGJIBhGtkGo2gTIOIa2AHQAyligDPo4tKK2BObarmWMAAzTtBwkOLajhtqoBEkMNRshJnFr%2BuZ2wNVTAJRYEGUVhlXuzUWWjSotcQkkpxyOhxDNkLRhsh0sgJowNnMFksVgx1rhNttdvtDsc0TNzpdUddbvcGA8njNgRR5KhDAArLLIK5YOm1LC2dAAdxiP0%2BABYnuZGABWfS2ZmGRjSDDoADU3hUpywTKJ5KwZBAXhUwy8wpUADYtSoABwAdhqAE4VKs6kKGHyxRL4Vh6KtlVcnnBYEgjMteOVKrh8N8Ae1OkMen0BkMxoUhshRgQSJZany47ZkMJaOh5OlmazbbcQCRaNmiHkAJ4u9CWfqDcUvWyuNiGRZEcV1OKuMEcgBy2nLVk1FqwJkMtAq9ZbbY7o/Hk6GPfQ/cHqGH1dr0d2yBIqGQ04Hs%2Bzm/rox3e6XK80Q68I6Cu/3rcPbPvF52y4H17Xt6etGxR0YJRVkoICQOA4ZszrIZZWGVwSB3UCCneUhkH4CdgA5dxZWw7DQJwmCSwIHAAC95SaUYcAwlYcO8YVzHMVwlGFNhbG8LxEOQ%2BD%2BG0bpKMwkB8PlYD8OGQiSLIrxhF4qisNo%2BjtCYli2NAgA3ZNtCSPCcOGHZkFlGpQMM4CjMoCDGXrGDNFLUDhnMIwiCIWUdAKAorCwfTVk81YTLMqDbBg5AMmQGzgHMQxNGTWVSB2GygqsfyTFQXSChMwytVlaQEBmWVsuQFJZRLMtK1lApaUcthRiykwQBANhkwIAAldBnFsSgiH2DN3NocxKIQZBzArKLDHKIoyllYJZVsQw9IIVASwQYY0pUArS3QcsBtlVxDAIWgSveWVRA4YRxFlPqInoAB6C7ORu4ZXJ69IFn2AYrGGeyLvSY19QunAiG0cwTLquympatqOqZLTcK1eRKGkNgAAlIdldJ9toub0nctGSHSJH2pUsjhVQY1Md1dGkd%2B/6CdQVwceEmitV4XsWBhuHEbpqGVBCBrRAAcVEXtKHEJGFQp8wqeJqmacEsiVC2dJ4fkWUACpZQ4f6BhMHq3NlDBaHV8benmeCxrsVxZSCd4xp2SXacofCFUZlhZS53n%2BcF4WtTx2UABJVnSW8ChqfVNBqGoCH1VwanQGpVhHKnsY92WQgANQJhq2AADRJ4UGpjpHaF3ABHbDfcybPqdt/CvbRmny4T9nzYQVBi9LlQCjryucJIVwzaxjGbdxwx8dL00XLH8eJ%2BwePO%2Bw7ve9J2vp6R4gTB9pg/bTJeG7pEhZRua9zH4DldzSJtyb%2BsXS5qL6SDdG3y4IGehuH9f/YtPlVmDrwSBqEhjWFTQrg%2BR/C3nbHCosqaPyRnPSB/ca5PwLs3H2fsaimnLjTQe%2BN4Ed3zk3Fufs244IbjAvu6Cn6WF3hAbBaMLRPFAfbLU9lEgZllM9Z%2BOUMyGCimtd4VZzY7COONLKu0Zi2DAAwPSGBIq%2BnQInPGxdSGyioaTGODw5FDwUSot0fckYYGCsBfeNYj7oBPl2EAmDkHpCiNYmx1js5lHISYpR1DSa0KIWAjmTC4h6TYV7XSXDEjtVQHwic8w5R5WyqI8RkiTFixkeolSmjCbY3csowmqiElUxju4/CejUrAUSrpcxDdIi0AQFTTQJgLFo1oCYculT87aE0JY7JVNakJKSdTHA7lX7GjSagSpaiG4KnkbKXp/TBlYB0cMz2Q9p7lwnJk72SFUAoXQTgCxpc77TI8bKJM9FZSFIzClBuFCVKyIbnooSYEbnRXFEjUp5S0YNIbtXUmtT6lVIbnrZpV9tnvK%2Bbsr2V9hSmj5IIVYURKDGl4J5Mh9NlpywVrKC6sp5C7gSPwAyry5mlwtMaC0%2BoJZo2NNLQSCpVbqxwJrHAVgUVooxUQfg7EcXDz9mwVYvA2A1BUD4bRriyUy1lGeeCOACD8EoD3el6K5pMpUMvZMYsgaNWanEMGPF9FArmYompGySmBCee8vVWrh4rJQmhPiZR1kKoOUczV%2BExyr11Zss1XEeLoUwtahu%2ByxZ2uFsM05Jjzm6PQJqskWA7SinZE6cM3Q0BRnrLGFU6xPQ%2BmGugf0bxUBBggCGNoQItgUDBEESE0JYRIQzImZMSQahpgrZmbMuZ8yagjUWYgIINzmSGPgLsB52yamFFgLsl5PxDkHWOCcW4%2B3il1HOSd9YR2rhAIO48XbtwPmnQOztfkRVvj7KOtcK7zyPhnFu18yBF1fmXb%2Bf8xxEr0kZBAQKQRZTiEoL2HmwhKA814KMWUmcM6ykoKMDgQzKDtooPwIgOwKZMowIXbQOAMCuAgMnXgDVRiiBCL2WU2otRgdAtmZAEBgMcH4CEeQ0gsO9j/WxJg6QVpFUsKgJgnIKgICYAQEwVSmhgaIxATgPABCkf4FEN9PNaNNDYrKAjwEiNKNGCEYQ6df3XNyVkCM8a/JjFArJygc80iZGyDuPI6An0pEM1kHIpmfZKFNIIRTym2C/rsywMD4bI2OiJFgSUVJQTglLTCd0qongpG7kOCATwNR8i8MMC0wo%2BTGiDklsF%2Bo%2BR8lNPqCNjAHTRu85KKYLoQBumTeGr0UAYCIA8MYMwzGc32Vq0OOg8QTBlOmi0QKqB6AQE0MyTQOxdwVmZF4jMIRbADWZMsUg9gUzefKJ0AY5z6DeYyFZwKzJdI1mZD1TQc1gktmWMyNAv1GCnCeAUG4dBk60s5AScUJx9D1qrSmWt6YG05jzN51kfwbj2A8H4PwEacBWXgE8QwJgtzLf0KuvyPamybs7E2S9Q46gToXLYBHc70fI7XHUGHW5d0nufHjmsa7Cc45fMezH56Kc1BvQcACD3lQylqIKEUXm0QFc%2BvqJgaXZTAAIAQJR8bbBkAeEotgAOfDuWlJgGWdR/01diKgGWKgHj6FK2qMLyw1yRfVCAFQfIdS3gtJl4BipDT6hHHaXLRBl3GmGCoJ3zuXcu6y/dznzpXTBZTc8SrEAkDPUiLCPAhAlfMd7ICRg3Ped8n54L4XhsxePfjM9mtdb4xZg%2B82v4aBMA4HcHUTkc1qqqmywwKNHv9AFbCBEcIrCCjIy%2BrH%2BPQun1J/FwJ8PdKFRq41x6ULJidf4DZ/afQdu%2BQ1GGPqGfs%2B5%2Bz7QVXnzXvis%2B7JFFg32pjQqEy/F1Yu%2BzSG8HXaFQHPq/Ok16PrwZ/l%2BFcv1gc5XX6wgD5EAA
https://compiler-explorer.com/#z:OYLghAFBqd5QCxAFwE4FN0BoCWIIDGAtgIYDW6AgqsAM4gDkAtACIDCAspQNICiA%2BgCEAqgEkAMi34AVAJoAFXgFIAzCxboARgFdgDLAQD2RAA44ANulTiSAO2DaSwdKIAmIAkoBMg74IPatMjGAPLayCbhAGIW6LYkROgoCOj86AAe6AThJJqWWABmsfSw6K44wahuIACMhbHVXl71lvGJIBhGtkGo2gTIOIa2AHQAyligDPo4tKK2BObarmWMAAzTtBwkOLajhtqoBEkMNRshJnFr%2BuZ2wNVTAJRYEGUVhlXuzUWWjSotcQkkpxyOhxDNkLRhsh0sgJowNnMFksVgx1rhNttdvtDsc0TNzpdUddbvcGA8njNgRR5KhDAArLLIK5YOm1LC2dAAdxiP0%2BABYnuZGABWfS2ZmGRjSDDoADU3hUpywTKJ5KwZBAXhUwy8wpUADYtSoABwAdhqAE4VKs6kKGHyxRL4Vh6KtlVcnnBYEgjMteOVKrh8N8Ae1OkMen0BkMxoUhshRgQSJZany47ZkMJaOh5OlmazbbcQCRaNmiHkAJ4u9CWfqDcUvWyuNiGRZEcVeN1xVxgjkAOW05asIANWBMhloFXrLbbHbd48n0dsvfQA6HqBH%2BurtaXo2QJFQyBng7n28Z9b3B%2BQK7XmmHo6CV%2BP7c1bsfh5vg7vG4NT1o2KORglFWShgNAkDhmzOshllYZXBIfcwIKd5SGQfhJ2ADl3FlHCcLA3DYJLAgcAAL3lJpRhwTCVlw7xhXMcxXCUYU2FsbwvCQlCEP4bRuiorCQAI%2BUQII4YiNI8ivGEPjqOwuiGO0ZjWPYsCADdk20JJ8Nw4YdmQWUajAoyQOMyhIPPGDhk0UswOGcwjCIIhZR0AoCisLADNWLzVlM8zoNsWDkAyZBbOAcxDE0ZNZVIHZbOCqwApMVA9IKUyjK1WVpAQGZZRy5AUllEsy0rWUClpJy2FGbKTBAEA2GTAgACV0GcWxKCIfYMw82hzCohBkHMCtosMcoijKWVgllWxDH0ghUBLBBhnSlRCtLdBy0G2VXEMAhaFK95ZVEDhhHEWV%2BoiegAHpLs5W7hjc3r0gWfYBisYYHMu9JjX1S6cCIbRzFM%2Br7Oa1r2s6pltLwrV5EoaQ2AACSh2V0gOuj5vSDz0ZIdJkY61TyOFVBjSx3UMeRv6AcJ1BXFxkTaK1Xg%2BxYWH4aR%2BnoZUEJGtEABxUQ%2B0ocRkYVSnzGpknqdpoTyJULZ0gR%2BRZQAKllDgAYGExevc2UMFoDWJt6eYEPGuxXFlIJ3nGnYpbpygCIVJmWFlbm%2BYFoWRa1fHZQAElWdIvAtAoan1TQahqAh9VcGp0BqVYLVJomcc9uWQgANUJxq2AADUTxq4%2BR2gDwARxwv3MkTmm7YI730dpyvk45i2EFQUvy5UAoG%2Br3CSFcc3scx228cMAny9NVyJ8nqfsGpxv7Z7vvba75HiBMX2mH9tNZ%2B7nC6RIWUbjvcx%2BA5A80ibCn/vF8uam%2Bkg3SX6mCB34bR43gOLT5VZQ68EgahIY0wpNCuD5H8bel8qbo2fsjXu/cybP0rrTQuJdfb%2BxqKaRBL9a5k3ruAputAW5t39h3ZeTdYHb0wcjSw%2B8IB10xujC0Tw8Hz05g5RIGZZQvVfrlDMhhorrXeFWC2OwjgTWyntGYtgwAMH0hgKKvp0Ap3xqXAeHlaFkzjg8JRI8VEaLdAPZGGAQogUPjWE%2B6Az7dhAMPUe/soj2IcfYxOZQX7UNlOoom9cGFMIMU3BUbC4j6S4d7PSfDEgdVQEIyc8w5T5RypI6RsiLHiwUdo1Suik6Dw8agTRaTqZx1ISw3W6BjHgTKUlPS1im6RAIdTTQJgbHU1oCYSu9TC7aE0Kg9IBSmkNL8V7HRUscAeXfsabJ9StH9JUMo2UozxkmCeL4opCpsGZMrpOPJPtkKoFQognAjTy4PyWQRJMDFZQVIzKlJu1DVKKKbkY4SZSwIxXFMjGpCA6l9KKas1AzTWlfIIvrTpN8jlk2aQctBwpTR8kEKsKIlBjS8C8pghmK15aK1lJdWU8gDwJH4IZJu3ty4WmNBafUkt0bGhlkJBUasNY4C1jgKwmLsW4qIPwDihKR5dLYKsXgbAagqB8PosmFpqWy1lJeAYBB%2BCUEXlinF812UqBXsmcWwMmotTiODXipSa7ctUU0/Z1TAgfPRhsrlo9tmoXQvxMoezVVnIuXq3C4417muNd87lWyuJoV4hhLCDqm6nPFs6kWfjrkWNuYYkpYEyRYDtKKdkTpwzdDQFGessYVTrE9D6Ea6B/RvFQEGCAIY2hAi2BQMEQRITQlhMhDMiZkxJBqGmBtmZsy5nzJqBNRZiAgjPP5fA3ZnwdmFFgbsn51wgHHQuKcQxR2alnROedy4diri/MOcd2YdwXn3IeRdupB27n3deddt4t0ulPYe7dp6p3fhnX%2BACxwkr0kZBAIKQRZTiEoH2XmwhKC814KMWUOds6ykoKMDgkzKD9ooPwIgOxKbsowMXbQOAMCuAgGnXgjVRiiBCH2WU2otQwbAtmZAEBIMcH4CEeQ0gCN9hA%2BxJg6RVrFUsKgJgnIKgICYAQEwDSmgwYoxATgPABDUf4FEH9vNmNNHYrKMjIEKPuNGCEYQWdgOPIIqmyM/kxhgWU5QWBaRMjZH3HkdAH6UhmayDkKzvslCmkEOpzTbBgPOZYDB%2BNibHREiwJKKkoJwS1phO6VUTwUi92HBAJ4Go%2BReGGBaYUfJjQh3S9C/UfI%2BSmi3HaB0yaAuSimC6EAbps3xq9FAGAiAPDGDMJxktDlGvDjoPEEwBCZotCCr8/AmhmSaB2AeCszIAkZhCLYQazJlikHsCmAL5ROgDFufQALGR7NBWZHpGszJeqaHmpElsyxmRoD%2BowU4TwCg3DoGnJlnICTihOPodtTaUytvTB2nMeYAusj%2BDcewHg/B%2BATTgay8AniGBMEuNb%2Bgd0WQbCO1sJ42STvPZujcdQ51LkXVjldS573DjqPD/yl4D3I5fMTmsCOydnv7Bjtk74jwU/FMTu96Pp01CfQcQCz3lQylqIKEU/m0Qla%2BvqJg2XZTAAIAQdx6bbBkAeO4tgwOfAeWlJgWWdRQMNdiKgWWKgHj6Eq2qaLywNxxfVCOPkOpA4Wjy6AxUhp9QJwK/oIgM7jTDBUL7v3/v/dbie6L50roIs5ueLViASAXqRFhHgQgevON9kBIwcXku%2BTS9l/Lo2SuXvxjey2tt8Yszfe7X8NAmAcDuDqJyeaNVVQJuF0VkPDAwgRHCJwgoKNvoZ6z3Lj9ufldiaT8yhURuTceiixYi3%2BAhf2g9yAPkNRhj6jX%2Bvjf6%2BMHB/0CVuH5Xw9kniyObUxoVB5ZS6sC/ZoVB8nHXaFQIvd/OlN/PrwT/Asv6n1gW5vz6xL6AA
In the patched version it just does the multiplication in a double. This obviously may lose some precision, but 


Compiler explorer demo used for patch:

https://compiler-explorer.com/#g:!((g:!((g:!((h:codeEditor,i:(filename:'1',fontScale:14,fontUsePx:'0',j:1,lang:c%2B%2B,selection:(endColumn:29,endLineNumber:11,positionColumn:29,positionLineNumber:11,selectionStartColumn:29,selectionStartLineNumber:11,startColumn:29,startLineNumber:11),source:'%23include+%3Cstdint.h%3E%0A%23include+%3Cstdio.h%3E%0A%23include+%3Ciostream%3E%0A%0Aint64_t+CalcRegen(double+max_hp,+double+multiplier,+int64_t+static_add)+%7B%0A++++multiplier+/%3D+10000000%3B%0A++++double+result+%3D+(max_hp*multiplier)%2Bstatic_add%3B%0A++++if((int64_t)+result+%3C+0)%7B%0A++++++++return+INT64_MAX%3B%0A++++%7D%0A++++return+(int64_t)+result%3B%0A%7D%0A%0Aint+main()%7B%0A++++std::cout+%3C%3C+(int64_t)+CalcRegen(23590929600000,+625000,+51787150000)++%3C%3C+std::endl%3B%0A%7D%0A%0A%0A//14,744,331+HP%0A//max_hp++++++++++++23590929600000%0A//multiplier++++++++625000%0A//total+++++++++++++14744331000000000000%0A//++++++++++++++++++147443310000000%0A//correct%3F+%3D++++++++1526220250000%0A//without+static+%3D++1474433100000%0A//int64_t+Min:+++++-9223372036854775808%0A//int64_t+Max:++++++9223372036854775807%0A%0A//uint64_t+min:+++++0%0A//uint64_t+max:+++++18446744073709551615'),l:'5',n:'0',o:'C%2B%2B+source+%231',t:'0')),k:49.24060751398881,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:g122,filters:(b:'0',binary:'0',commentOnly:'0',demangle:'0',directives:'0',execute:'0',intel:'0',libraryCode:'0',trim:'1'),flagsViewOpen:'1',fontScale:14,fontUsePx:'0',j:1,lang:c%2B%2B,libs:!(),options:'',selection:(endColumn:1,endLineNumber:1,positionColumn:1,positionLineNumber:1,selectionStartColumn:1,selectionStartLineNumber:1,startColumn:1,startLineNumber:1),source:1,tree:'1'),l:'5',n:'0',o:'x86-64+gcc+12.2+(C%2B%2B,+Editor+%231,+Compiler+%231)',t:'0')),k:33.48413706009982,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:output,i:(compilerName:'x86-64+gcc+12.2',editorid:1,fontScale:14,fontUsePx:'0',j:1,wrap:'1'),l:'5',n:'0',o:'Output+of+x86-64+gcc+12.2+(Compiler+%231)',t:'0')),k:17.275255425911375,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4